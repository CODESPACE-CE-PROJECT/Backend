generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["omitApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  schoolId   String      @id @default(uuid())
  schoolName String
  courses    Course[]
  permission Permission?
  users      Users[]
}

model Permission {
  permissionId              String  @id @default(uuid())
  maxCreateTeacher          Int
  maxCreateStudent          Int
  maxCreateCoursePerTeacher Int
  canCreateUser             Boolean
  canUpdateUser             Boolean
  canDeleteUser             Boolean
  schoolId                  String  @unique
  school                    School  @relation(fields: [schoolId], references: [schoolId], onDelete: Cascade)
}

model Users {
  username       String           @id
  email          String?
  hashedPassword String
  studentNo      String?
  firstName      String
  lastName       String
  gender         Gender
  role           Role             @default(STUDENT)
  picture        String?
  containerID    String?
  IpAddress      String?
  isActived      Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  schoolId       String
  codeSpace      CodeSpace[]
  course         Course[]
  courseAnnounce CourseAnnounce[]
  courseStudent  CourseStudent[]
  courseTeacher  CourseTeacher[]
  replyAnnounce  ReplyAnnounce[]
  submission     Submission[]
  school         School           @relation(fields: [schoolId], references: [schoolId], onDelete: Cascade)
}

model CodeSpace {
  codeSpaceId String @id @default(uuid())
  language    String
  sourceCode  String
  fileName    String
  username    String
  user        Users  @relation(fields: [username], references: [username], onDelete: Cascade)
}

model Course {
  courseId       String           @id @default(uuid())
  title          String
  description    String?
  username       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  schoolId       String
  backgroundUrl  String?
  assignment     Assignment[]
  school         School           @relation(fields: [schoolId], references: [schoolId], onDelete: Cascade)
  user           Users            @relation(fields: [username], references: [username], onDelete: Cascade)
  courseAnnounce CourseAnnounce[]
  courseStudent  CourseStudent[]
  courseTeacher  CourseTeacher[]
}

model CourseAnnounce {
  courseAnnounceId String          @id @default(uuid())
  title            String
  description      String
  username         String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  courseId         String
  course           Course          @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  user             Users           @relation(fields: [username], references: [username], onDelete: Cascade)
  replyAnnounce    ReplyAnnounce[]
}

model ReplyAnnounce {
  replyAnnounceId  String         @id @default(uuid())
  message          String
  username         String
  courseAnnounceId String
  createAt         DateTime       @default(now())
  updateAt         DateTime       @updatedAt
  courseAnnounce   CourseAnnounce @relation(fields: [courseAnnounceId], references: [courseAnnounceId], onDelete: Cascade)
  user             Users          @relation(fields: [username], references: [username], onDelete: Cascade)
}

model CourseStudent {
  courseStudentId String @id @default(uuid())
  username        String
  courseId        String
  course          Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  user            Users  @relation(fields: [username], references: [username], onDelete: Cascade)
}

model CourseTeacher {
  courseTeachertId String @id @default(uuid())
  username         String
  courseId         String
  course           Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  user             Users  @relation(fields: [username], references: [username], onDelete: Cascade)
}

model Assignment {
  assignmentId      String         @id @default(uuid())
  title             String
  description       String
  isLock            Boolean
  language          LanguageType   @default(PYTHON)
  problemQuantities Int            @default(1)
  type              AssignmentType
  startAt           DateTime?
  expireAt          DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  courseId          String
  course            Course         @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  problem           Problem[]
}

model Problem {
  problemId    String       @id @default(uuid())
  title        String
  description  String
  hint         String?
  revaleCode   String?
  score        Int
  isRegex      Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  assignmentId String
  constraint   Constraint[]
  assignment   Assignment   @relation(fields: [assignmentId], references: [assignmentId], onDelete: Cascade)
  submission   Submission[]
  testCases    TestCase[]
}

model TestCase {
  testCaseId String  @id @default(uuid())
  input      String
  output     String
  isHidden   Boolean
  problemId  String
  problem    Problem @relation(fields: [problemId], references: [problemId], onDelete: Cascade)
}

model Submission {
  submissionId String   @id @default(uuid())
  sourceCode   String
  status       Boolean
  createdAt    DateTime @default(now())
  username     String
  problemId    String
  no           Int
  result       Json?    @db.Json
  problem      Problem  @relation(fields: [problemId], references: [problemId], onDelete: Cascade)
  user         Users    @relation(fields: [username], references: [username], onDelete: Cascade, map: "Submission_userId_fkey")
}

model Constraint {
  constraintId String  @id @default(uuid())
  type         String
  keyword      String
  quantities   Int
  problemId    String
  problem      Problem @relation(fields: [problemId], references: [problemId], onDelete: Cascade)
}

enum Gender {
  MALE
  FEMALE
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum AssignmentType {
  EXERCISE
  QUIZ
  EXAM
}

enum LanguageType {
  PYTHON
  C
  CPP
  JAVA
}
